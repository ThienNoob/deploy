name: CD K8s

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: self-hosted

    # Increase job timeout to 30 minutes
    timeout-minutes: 30

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - name: Apply file yaml
        run: |
          sudo kubectl apply -f persistentVolume.yaml 
          sudo kubectl apply -f secret.yaml 
          sudo kubectl apply -f configMap.yaml 
          sudo kubectl apply -f service.yaml 
          sudo kubectl apply -f deployment.yaml 
      - name: Wait for all Pods to be Running
        run: |
          for i in {1..60}; do
            if sudo kubectl get pods --all-namespaces | grep -v Running | grep -v Completed; then
              echo "Waiting for pods to be in Running state..."
              sudo kubectl get all
              sleep 10
            else
              echo "All pods are in Running state."
              sudo kubectl get all
              break
            fi
          done
      - name: Check resources
        run: |
          sudo kubectl get all
